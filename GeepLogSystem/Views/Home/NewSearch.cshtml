@{
    Layout = "~/Views/_LayoutPage.cshtml";
    <link href="~/Style/search.css" rel="stylesheet" />
}
<div id="app">
    <span class="form-wrapper cf">
        <input id="inputtext" v-on:keyup.enter="search" v-model="q" type="text" placeholder="搜索关键词" required>
        <button type="button" v-on:click="search">搜索</button>
    </span>
    <div>
        <span style="float:left;line-height:69px;padding-right:30px;">共找到： {{count}} 条数据</span>
        <ul class="pagination pagination-demo pagination-sm"></ul>
        <a id="export-a" href="javascript:;"><span id="export-span" v-on:click="export">结果导出</span></a>
    </div>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>类型</th>
                <th>ip地址</th>
                <th>时间</th>
                <th>类名</th>
            </tr>
        </thead>
        <tbody id="interpolation">
            <tr v-for="item in list" data-time="{{item.Time}}" data-class="{{item.Class}}" data-Ip="{{item.Ip}}" data-description="{{item.Description}}" class="zft-tr" v-on:click="logClick">
                <th v-if="item.IsErrorLog"><span class="glyphicon glyphicon-remove"></span>&nbsp;{{item.LogName}} </th>
                <th v-else><span class="glyphicon glyphicon-ok"></span>&nbsp;{{item.LogName}}</th>
                <th>{{item.Ip}}</th>
                <th>{{item.Time}}</th>
                <th>{{item.Class}}</th>
            </tr>
        </tbody>
    </table>
</div>
@section script{
    <script src="~/Scripts/vue.js"></script>
    <script src="~/Scripts/vue-resource.js"></script>
    <link href="~/Scripts/dialog/css/bootstrap-dialog.min.css" rel="stylesheet" />
    <script src="~/Scripts/dialog/js/bootstrap-dialog.min.js"></script>
    <script src="~/Scripts/jqPaginator.min.js"></script>
    <script>
        $('#@ViewBag.ActiveId').addClass('active');
        document.getElementById('inputtext').focus();
        //Vue.use('vue-resource');
        var vm = new Vue({
            el: '#app',
            data: {
                q: '',
                list: '',
                count: 0
            },
            methods: {
                search: function () {
                    if (!this.q) {
                        alert("搜索条件为空");
                    } else {
                        this.$http({ url: '/api/InsertLog/TextSearch?q=' + this.q, method: 'GET' }).then(function (response) {
                            InitData(response)
                        }, function (response) {
                            alert("请求错误");
                        });
                    }
                    
                },
                logClick: function (event) {
                    var self = event.currentTarget,
                        Trade_Type = $(self).attr('data-Class'),
                        Trade_Ip = $(self).attr('data-Ip'),
                        Trade_Time = $(self).attr('data-Time'),
                        Message = $(self).attr('data-description'),

                        textAndPic = $('<div></div>');
                    textAndPic.append('<b>类名：</b>' + Trade_Type + '</br><hr>');
                    textAndPic.append('<b>ip地址：</b>' + Trade_Ip + '</br><hr>');
                    textAndPic.append('<b>时间：</b>' + Trade_Time + '</br><hr>');
                    textAndPic.append('<b>附加信息：</b>' + Message + '</br>');

                    BootstrapDialog.show({
                        title: '日志详情',
                        message: textAndPic,
                        buttons: [{
                            label: '关闭',
                            action: function (dialogItself) {
                                dialogItself.close();
                            }
                        }],
                        onshown: function () {
                            $('.modal-content').css('overflow-y', 'auto');
                        }
                    })
                },
                page: Page,
                export: function () {
                    if (!this.q) {
                        alert("搜索条件为空");
                    } else {
                        $('#export-span').text('导出中。。');
                        this.$http({ url: '/api/InsertLog/Export?q=' + this.q, method: 'GET' }).then(function (response) {
                            alert("导出成功" + response.data);
                            $('#export-span').text('结果导出');
                        }, function (response) {
                            alert("导出错误");
                            $('#export-span').text('结果导出');
                        });
                    }
                    
                }
            }

        });
        function InitData(response) {
            if (response && response.data && response.data.length > 0) {
                var data = response.data;
                vm.count = response.data.length;
                vm.list = data;
                //vm.page();
                $('.form-wrapper').animate({ marginTop: "10px", marginBottom: "25px" }, 800);
            } else {
                alert('没有找到对应的结果');
                vm.list = '';
                vm.count = 0;
            }
        };
        function Page() {
            $(".pagination-demo").jqPaginator({
                totalCounts: vm.count,
                pageSize: 15,
                visiblePages: 10,
                currentPage: 1,
                first: '<li class="first"><a href="?p=1">首页<\/a><\/li>',
                prev: '<li class="prev"><a href="?p={{page}}">上一页<\/a><\/li>',
                next: '<li class="next"><a href="?p={{page}}">下一页<\/a><\/li>',
                last: '<li class="last"><a href="?p={{totalPages}}">末页<\/a><\/li>',
                page: '<li class="page"><a href="?p={{page}}">{{page}}<\/a><\/li>',
                onPageChange: function (n) {
                    $(".pagination-demo .disabled").each(function () {
                        $(this).find('a').attr('href', '#');
                    })
                }
            });

        };
    </script>
}

